version: 0.2
phases:
  install:
    commands:
      - yarn
      - pip install twine
      - dotnet tool install -g AWS.CodeArtifact.NuGet.CredentialProvider
  pre_build:
    commands:
      - dotnet codeartifact-creds install
  build:
    commands:
      - npx projen release
      - echo "npx typedoc --tsconfig ./tsconfig.dev.json"
  post_build:
    commands:
      - env
      - git config user.name "codecommit"
      - git config user.email "codecommit@amazonaws.com"
      - git remote -v
      - RELEASE_TAG="$(cat dist/releasetag.txt)"
      - echo "Using release tag '${RELEASE_TAG}'"
      - git tag "${RELEASE_TAG}"
      - git push origin "${RELEASE_TAG}"
      - CODE_ARTIFACT_TOKEN="$(aws codeartifact get-authorization-token --domain "${CODE_ARTIFACT_DOMAIN}" --domain-owner "${CODE_ARTIFACT_OWNER}" --query authorizationToken --output text)"
      - >-
          MAVEN_USERNAME='aws'
          MAVEN_PASSWORD="${CODE_ARTIFACT_TOKEN}"
          MAVEN_SERVER_ID='codeartifact'
          MAVEN_REPOSITORY_URL="$(aws codeartifact get-repository-endpoint --domain "${CODE_ARTIFACT_DOMAIN}" --repository jsii --format maven --query repositoryEndpoint --output text)"
          NPM_DIST_TAG='latest'
          NPM_REGISTRY="$(aws codeartifact get-repository-endpoint --domain "${CODE_ARTIFACT_DOMAIN}" --repository jsii --format npm --query repositoryEndpoint --output text | sed -r 's!^https?://!!')"
          NUGET_API_KEY="${CODE_ARTIFACT_TOKEN}"
          NUGET_SERVER="$(aws codeartifact get-repository-endpoint --domain "${CODE_ARTIFACT_DOMAIN}" --repository jsii --format nuget --query repositoryEndpoint --output text)v3/index.json"
          TWINE_USERNAME='aws'
          TWINE_PASSWORD="${CODE_ARTIFACT_TOKEN}"
          TWINE_REPOSITORY_URL="$(aws codeartifact get-repository-endpoint --domain "${CODE_ARTIFACT_DOMAIN}" --repository jsii --format pypi --query repositoryEndpoint --output text)"
          npx -p publib@latest publib
