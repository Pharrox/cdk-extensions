version: 0.2
phases:
  install:
    commands:
      - yum install -y tree
      - yarn
      - pip install twine
  build:
    commands:
      - npx projen release
      - MAVEN_METADATA_DIR="$(dirname "$(find ./dist/java/ -name 'maven-metadata.xml' -type f | head -1)")"
      - MAVEN_RELEASE_DIR="$(find "${MAVEN_METADATA_DIR}" -maxdepth 1 -regex '.*/[0-9]\.[0-9]\.[0-9]' -type d | head -1)"
      - echo 'Poms:'
      - find "${MAVEN_METADATA_DIR}" -name '*.pom' -exec cat {} \;
      - echp 'Maven metadata:'
      - find "${MAVEN_METADATA_DIR}" -name 'maven-metadata.xml' -exec cat {} \;
      - find "${MAVEN_METADATA_DIR}" -name 'maven-metadata.xml*' -exec mv {} "${MAVEN_RELEASE_DIR}" \;
      - tree dist
      - echo "npx typedoc --tsconfig ./tsconfig.dev.json"
  post_build:
    commands:
      - CODE_ARTIFACT_TOKEN="$(aws codeartifact get-authorization-token --domain "${CODE_ARTIFACT_DOMAIN}" --domain-owner "${CODE_ARTIFACT_OWNER}" --query authorizationToken --output text)"
      - >-
          MAVEN_USERNAME='aws'
          MAVEN_PASSWORD="${CODE_ARTIFACT_TOKEN}"
          MAVEN_SERVER_ID='codeartifact'
          MAVEN_REPOSITORY_URL="$(aws codeartifact get-repository-endpoint --domain "${CODE_ARTIFACT_DOMAIN}" --repository jsii --format maven --query repositoryEndpoint --output text)"
          NPM_DIST_TAG='latest'
          NPM_REGISTRY="$(aws codeartifact get-repository-endpoint --domain "${CODE_ARTIFACT_DOMAIN}" --repository jsii --format npm --query repositoryEndpoint --output text | sed -r 's!^https?://!!')"
          NUGET_API_KEY="${CODE_ARTIFACT_TOKEN}"
          NUGET_SERVER="$(aws codeartifact get-repository-endpoint --domain "${CODE_ARTIFACT_DOMAIN}" --repository jsii --format nuget --query repositoryEndpoint --output text)v3/index.json"
          TWINE_USERNAME='aws'
          TWINE_PASSWORD="${CODE_ARTIFACT_TOKEN}"
          TWINE_REPOSITORY_URL="$(aws codeartifact get-repository-endpoint --domain "${CODE_ARTIFACT_DOMAIN}" --repository jsii --format pypi --query repositoryEndpoint --output text)"
          npx -p publib@latest publib
